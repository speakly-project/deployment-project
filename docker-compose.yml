services:
#--------------banco-------------------------------
  speakly-bank-mariadb:
      image: mariadb:latest
      container_name: speakly-bank-mariadb
      environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: speakly_bank
      healthcheck:
        test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-uroot", "-proot"]
        interval: 10s
        timeout: 5s
        retries: 5
      networks:
        - proxy_red

  speakly-bank-back:
    build:
      context: .
      dockerfile: Dockerfile-bank-back
    container_name: speakly-bank-back
    #ports: #para probar en local
    #  - "8080:8080"
    environment:
      VIRTUAL_HOST: speakly-bank-back.preproducciondaw.cip.fpmislata.com
      # sobrescribir application.properties
      SPRING_DATASOURCE_URL: jdbc:mariadb://speakly-bank-mariadb:3306/speakly_bank?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
    #https://docs.docker.com/reference/compose-file/services/#depends_on, depends_on, no funciona por migraciones?
    depends_on:
      speakly-bank-mariadb:
        condition: service_healthy
    networks:
      - proxy_red
  speakly-bank-front:
    build:
      context: .
      dockerfile: Dockerfile-bank-front
    container_name: speakly-bank-front
    #ports: # para probar en local
    #  - "4200:80"
    environment:
      VIRTUAL_HOST: speakly-bank.preproducciondaw.cip.fpmislata.com
    depends_on:
      - speakly-bank-back
    networks:
      - proxy_red

#--------------store-----------------------

  speakly-mariadb:
      image: mariadb:latest
      container_name: speakly-mariadb
      environment:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: speakly
      healthcheck:
        test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-uroot", "-proot"]
        interval: 10s
        timeout: 5s
        retries: 5
      networks:
        - proxy_red

  speakly-store-back:
    build:
      context: .
      dockerfile: Dockerfile-store-back
    container_name: speakly-store-back
    env_file:
     - .speakly-env
    environment:
      VIRTUAL_HOST: speakly-store-back.preproducciondaw.cip.fpmislata.com
      # sobrescribir application.properties
      SPRING_DATASOURCE_URL: jdbc:mariadb://speakly-mariadb:3306/speakly?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
    depends_on:
      speakly-mariadb:
        condition: service_healthy
    networks:
      - proxy_red

  speakly-store-adm-front:
    build:
      context: .
      dockerfile: Dockerfile-store-adm-front
    container_name: speakly-store-adm-front
    environment:
      VIRTUAL_HOST: speakly-store-adm.preproducciondaw.cip.fpmislata.com
    depends_on:
      - speakly-store-back
    networks:
      - proxy_red

  speakly-store-front:
    build:
      context: .
      dockerfile: Dockerfile-store-front
    container_name: speakly
    environment:
      VIRTUAL_HOST: speakly.preproducciondaw.cip.fpmislata.com
    depends_on:
      - speakly-store-back
    networks:
      - proxy_red

networks:
  proxy_red:
    external:
      name: nginx-proxy-network